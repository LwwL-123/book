# EIP-1559

一种交易定价机制，包括按区块固定的网络费用，该费用会被销毁并动态扩展/收缩区块大小以应对瞬时拥塞。



## Abstract

引入了一种新的 EIP-2718 交易类型，其格式为 `0x02 || rlp([chain_id, nonce, max_priority_fee_per_gas, max_fee_per_gas, gas_limit, destination, amount, data, access_list, signature_y_parity, signature_r, signature_s])` 

协议中每个 Gas 都有一个基本费用，它可以根据父块中使用的 Gas 和父块的 Gas 目标（块 Gas 限制除以弹性乘数）的函数向上或向下移动每个块。该算法导致当区块高于 Gas 目标时，每种 Gas 的基本费用增加；当区块低于 Gas 目标时，每种 Gas 的基本费用减少。每份 Gas 的基本费用都会被烧掉。交易指定了他们愿意向矿工支付的每份 Gas 的最高费用，以激励他们纳入交易（又名：优先费）。交易还指定了他们愿意支付的每项 Gas 的最高费用（又称：最大费用），其中包括优先费用和每项 Gas 的区块网络费用（又称：基本费用）。交易将始终为其所包含的区块的每项 Gas 支付基本费用，并且只要两项费用的总和不超过交易的最高费用，他们将支付交易中设置的每项 Gas 的优先费用每气体。

## 动机

以太坊历史上使用简单的拍卖机制对交易费用进行定价，其中用户发送带有出价（“gasprice”）的交易，矿工选择出价最高的交易，并且包含在内的交易支付他们指定的出价。这导致了效率低下的几个主要根源：

- 交易费用水平的波动性与交易的社会成本之间的不匹配：包含成熟公共区块链上交易的出价，这些交易有足够的使用量，使得区块已满，往往波动性极大。认为当每项 Gas 的成本为 10 nanoeth时，网络因在一个区块中再接受一笔交易而产生的成本实际上是每项 Gas 的成本为 1 nanoeth的 10 倍，这是荒谬的；在这两种情况下，800 万个 Gas 和 802 万个 Gas 之间存在差异。

- 对用户来说不必要的延迟：由于每个区块的 Gas 硬性限制加上交易量的自然波动，交易通常会等待几个区块才能被纳入，但这在社会上是没有生产力的；没有人能从这样一个事实中获益匪浅：不存在允许一个区块变大而下一个区块变小的“松弛”机制，以满足逐个区块的需求差异。

- 首价拍卖效率低下：目前的方法是，交易发送者以最高费用出价发布交易，矿工选择支付最高的交易，每个人都按他们的出价支付。在机制设计文献中众所周知，这是非常低效的，因此需要复杂的费用估计算法。但即使是这些算法最终也常常无法很好地发挥作用，导致频繁多付费用。
- 无区块奖励的区块链不稳定：从长远来看，目前没有发行的区块链（包括比特币和Zcash）都打算转而完全通过交易费来奖励矿工。然而，存在一些已知问题，可能会导致很多不稳定，激励挖掘窃取交易费用的“姐妹块”，开启更强大的自私挖掘攻击向量等等。目前还没有好的缓解措施。

该 EIP 中的建议是从基本费用金额开始，该金额由协议根据网络拥塞程度进行上下调整。当网络超过目标每块 Gas 使用量时，基本费用略有增加，当容量低于目标时，基本费用略有减少。由于这些基本费用的变化受到限制，因此区块之间基本费用的最大差异是可以预测的。这样钱包就可以以高度可靠的方式自动为用户设置燃气费。预计大多数用户无需手动调整 Gas 费用，即使在网络活动频繁的时期也是如此。对于大多数用户来说，基本费用将由他们的钱包估算，并且将自动设置少量优先费用，以补偿矿工承担的孤儿风险。用户还可以手动设置交易最高费用来限制总成本。

该费用制度的一个重要方面是矿工只能保留优先费。基本费用总是会被销毁（即它被协议销毁）。这确保了只有 ETH 才能用于支付以太坊上的交易，从而巩固了 ETH 在以太坊平台内的经济价值，并降低了与矿工可提取价值 (MEV) 相关的风险。此外，这种销毁可以抵消以太坊通货膨胀，同时仍然向矿工提供区块奖励和优先费。最后，确保区块的矿工不会收到基本费用很重要，因为它消除了矿工操纵费用以从用户那里获取更多费用的动机。

## Specification

块有效性在下面的参考实现中定义。 `GASPRICE` ( `0x3a` ) 操作码必须返回 `effective_gas_price` ，如下面的参考实现中所定义。

从 `FORK_BLOCK_NUMBER`开始, 用[EIP-2718](https://eips.ethereum.org/EIPS/eip-2718)引入with `TransactionType` 2.

新交易的内在成本继承自 EIP-2930，特别是 `21000 + 16 * non-zero calldata bytes + 4 * zero calldata bytes + 1900 * access list storage key count + 2400 * access list address count` 。

此交易的 EIP-2718 `TransactionPayload` 是 `rlp([chain_id, nonce, max_priority_fee_per_gas, max_fee_per_gas, gas_limit, destination, amount, data, access_list, signature_y_parity, signature_r, signature_s])` 。

此交易的 `signature_y_parity, signature_r, signature_s` 元素表示 `keccak256(0x02 || rlp([chain_id, nonce, max_priority_fee_per_gas, max_fee_per_gas, gas_limit, destination, amount, data, access_list]))` 上的 secp256k1 签名。

此交易的 EIP-2718 `ReceiptPayload` 是 `rlp([status, cumulative_transaction_gas_used, logs_bloom, logs])` 。

## 向后兼容性

传统的以太坊交易仍然有效并包含在区块中，但它们不会直接从新的定价系统中受益。这是因为从旧事务升级到新事务会导致旧事务的 `gas_price `完全被 `base_fee_per_gas` 和 `priority_fee_per_gas` 消耗。

### 块哈希更改

传递到 keccak256 来计算块哈希的数据结构正在发生变化，所有验证块是否有效或使用块哈希来验证块内容的应用程序都需要进行调整以支持新的数据结构（一项附加项目）。如果您只获取块头字节并对它们进行散列，您仍然应该正确地获得散列，但是如果您从其组成元素构建块头，则需要在末尾添加新的块头。

### GASPRICE

在此更改之前， `GASPRICE` 代表签名者为每笔交易支付的 ETH 以及矿工每笔 Gas 收到的 ETH。自此更改以来， `GASPRICE` 现在仅表示签名者为每项 Gas 支付的 ETH 金额，并且矿工为交易支付的金额不再可以直接在 EVM 中访问。

## 安全注意事项

### 增加最大块大小/复杂性

该 EIP 将增加最大区块大小，如果矿工无法足够快地处理区块，这可能会导致问题，因为这将迫使他们开采空区块。随着时间的推移，平均块大小应保持与没有此 EIP 时大致相同，因此这只是短期大小爆发的问题。一个或多个客户端可能无法很好地处理短期大小突发和错误（例如内存不足或类似情况），并且客户端实现应确保其客户端能够正确处理最大大小的单个块。

### 交易排序

由于大多数人不参与优先费用竞争，而是使用基准费用来参与，交易排序现在取决于单个客户的内部实现细节，例如他们如何将交易存储在内存中。建议按收到交易的时间对具有相同优先级费用的交易进行排序，以保护网络免受垃圾邮件攻击，攻击者将一堆交易放入待处理池中，以确保至少有一个交易处于有利位置。纯粹从自私的挖矿角度来看，矿工仍然应该更喜欢较高 Gas 溢价的交易，而不是那些较低 Gas 溢价的交易。

### 矿工开采空块

矿工有可能会挖掘空块，直到基本费用非常低，然后继续挖掘半满块并恢复按优先费用对交易进行排序。虽然这种攻击是可能的，但只要挖矿是去中心化的，它就不是一个特别稳定的平衡。只要攻击持续下去（即使在基本费用达到 0 之后），任何从该策略中叛逃的人都将比参与攻击的矿工获得更多的利润。由于任何矿工都可以匿名从卡特尔中叛逃，并且无法证明特定矿工叛逃，因此执行此攻击的唯一可行方法是控制 50% 或更多的算力。如果攻击者恰好拥有 50% 的算力，他们将不会从优先费中赚取以太币，而叛逃者将从优先费中赚取双倍的以太币。对于攻击者来说，想要盈利，他们需要拥有超过 50% 的算力，这意味着他们可以执行双花攻击，或者干脆忽略任何其他矿工，这是一种更有利可图的策略。

### ETH 销毁排除了固定供应量

通过燃烧基本费用，我们无法再保证固定的以太币供应。这可能会导致经济不稳定，因为 ETH 的长期供应将不再随着时间的推移而保持稳定。虽然这是一个合理的担忧，但很难量化这将产生多大的影响。如果基本费用燃烧的数量多于挖矿奖励产生的数量，那么 ETH 将出现通货紧缩，如果挖矿奖励产生的数量多于燃烧的数量，那么 ETH 将出现通货膨胀。由于我们无法控制用户对区块空间的需求，我们目前无法断言 ETH 是否会最终出现通胀或通缩，因此这一变化导致核心开发者失去了对 ETH 长期数量的部分控制。