# sui交易与共识

Sui是基于Move语言的主要的新L1公链之一，其技术发展得到了主要媒体和资本的关注。相比许多其他新的L1公链，特别是Aptos，Sui拥有一整套新颖的设计、技术创新和独特的代币经济学，可提供一个几乎拥有无限“横向扩展性”的区块链。本文将介绍Sui的主要技术突破，以及项目独特的代币经济学模型，最后将批判性地评估Sui作为主打可扩展性的L1公链的潜力。



## 1. 简单的单写者交易

Sui对简单的“单写者”（single-writer）交易的处理可以说是该项目最重要的创新，也是项目可扩展性的关键保障。顾名思义，单写者交易包括点对点支付和NFT交易等常见的区块链交易，其中只涉及一个发送者。Sui称他们“针对单写者对象进行了优化，通过设计为简单交易免除了共识需求”。这似乎与区块链设计原则相悖，毕竟共识是确保区块链发送数据安全性的关键步骤。那么，Sui如何在没有共识的情况下保障数据安全呢？

这里的关键是Sui使用了一种“拜占庭共识广播”算法，这是一种更简单的算法，消除了传统共识方法的额外成本，同时仍能保证拜占庭对抗条件（基本是对共识的标准安全要求）下的安全性和活跃度。该算法类似于通常用于为网页创建安全连接的传输层安全（TLS）算法。

在传统共识机制中，针对发送者有一种“即发即忘”（fire-and-forget）的处理方法，即向验证者提交交易后，发送者不再对交易做任何操作，完全交由验证者完成剩余工作。因为验证者需要检查该交易是否与其他客户发来的其他交易相冲突。但在简单的“单写者”操作情况下，我们已经知道不会有来自其他发送者的冲突写入。因此，我们可以将计票的计算负担交给发送者，而不必浪费宝贵的验证者算力。



<img src="https://picture-1258612855.cos.ap-shanghai.myqcloud.com/202304131411039.png" alt="Sui的技术创新：对Sui的批判性分析" style="zoom:50%;" />

具体而言，简单交易会经过四个步骤：

1. 发送者向验证者发送交易数据，并进行记录
2. 验证者将（权益证明加权）投票发回给发送者
3. 发送者对验证者收到的所有投票进行统计，一旦超过验证阈值，就会创建一个“验证证书”，并发送回验证者
4. 验证者收到证书后会检查其有效性，然后立即完成交易。

由于验证者之间无需相互通信（与传统共识一样），通过这一巧妙算法，简单交易几乎不会对Sui网络上的验证者产生什么计算成本，而证书机制也为交易安全提供了相当程度的可靠性。

更重要的是，这一算法具有高度的可扩展性。基于这一巧妙算法，理论上Sui网络可以处理的简单交易数量没有上限。由于统计验证者投票的主要计算在客户端完成，即使有越来越多的人使用Sui网络，验证者也不必面对与在以太坊、Solana甚至Aptos相同的计算压力（用户基本独自承担了计算任务）。因此，Sui的创建者们在宣传中称其与其他区块链存在质的不同，因为它使用了“横向扩展”策略。



## 2. 共识 - Narwhal

当然，虽然Sui针对简单的单写者交易进行了优化，但它也有更“传统”的全局共识机制，可处理更复杂的交易，并定期检查区块链的全局状态。这种利用图形（更具体地说是有向无环图）数据结构的共识引擎本身也是一种前沿机制。Sui的共识引擎主要由两个部分组成：

1. Narwhal是Sui的内存池，主要是充当管家角色，负责检查待处理的共识交易 。
2. Tusk（及其前身Bullshark）是确保共识交易有序进行的协议。

本质上，Narwhal会聚合一批待处理交易，在等待处理时对它们进行“图形化”。不同于传统区块链共识中将交易卷入确认区块的做法，Narwhal会为交易标记上版本号，以及指向先前交易版本号的指示标记，以创建类似于文件树的有向无环图（DAG）。这一DAG结构与Arweave的“blockweave”概念很像，它会将区块链的单维LinkedList式结构转换为类似文件树的图形，以更有效地存储数据。

Tusk本质上也是HotStuff共识协议的修改版本，它针对Narwhal提供的DAG结构进行了优化，专注于减少网络验证者之间的通信麻烦。结合使用Narwal和Tusk可在传统的拜占庭容错（BFT）条件下实现高达“160,000笔交易/秒，延迟约3秒”的交易速度。因此即便不考虑Sui使用上述拜占庭共识广播算法为单写者交易所做的额外优化，Narwal-Tusk的交易效率也已经出类拔萃。



### 2.1当前的内存矿池协议

传统的共识协议可以被称为“单体”，因为它们将各种各样的功能捆绑在一起——这些功能可以在其他地方解决。

例如，在比特币上，客户端软件将交易广播到验证节点，然后验证节点使用内存矿池协议传播它们。因此，这些交易的一部分会定期共享多次。

为了提高网络交易吞吐量，研究中心化在优化共识协议上。一种想法是将元数据（在传输期间）从较大的消息中分离出来，但这并不能保证系统的可用性。即使是最小的网络中断，这些协议也会受到严重影响。

将内存矿池和共识层耦合会限制系统的整体吞吐量。这些限制尤其源于预共识交易的传播。



### 2.2 优化内存矿池

为了设计高性能的分布式账本，研究人员专注于优化内存矿池。这个想法是将其与共识协议分开。

后者仅支持小的、固定大小的引用。因此，系统的整体吞吐量在很大程度上不受共识机制的吞吐量的影响。

使用 Narwhal，交易的传播因此仅限于内存矿池协议。共识只会对非常少量的元数据进行排序，从而显着提高系统性能。



- Narwhal：一种先进的 Mempool 协议，即使在异步模式下也能保证最佳吞吐量（基于网络速度）。
- 与 Hotstuff 结合使用，吞吐量增加，但延迟成本适中。

然后，研究人员利用 Narwhal 的框架创建了 Tusk，这是一种高速、抗 DDoS 且没有瓶颈的共识协议。Tusk 源自 DAG-Rider，即使发生故障，它的性能也得到了证明。

![image-20230413163732012](https://picture-1258612855.cos.ap-shanghai.myqcloud.com/202304131637039.png)

传统内存矿池（圆圈）、独角鲸（星号）和在不同机器（交叉）上优化的独角鲸之间的比较——512 KB 事务。

上图描述了基于经典内存矿池的系统的性能，然后是独角鲸，用于不同数量的验证器和机器。可以注意到，通过利用 Narwhal 的可并行化特性（通过增加机器数量），吞吐量增加了。



### 2.3 Narwhal的构想

因此，独角鲸必须确保用户在完全异步网络上提交的交易的可用性和完整性。

该存储层是分布式的、结构化的、持久的并且可以容忍拜占庭错误。Narwhal 提供事务的可用性和部分调度。

### 2.4 目标和假设

我们的分布式系统确保消息的传播并且有 n 个参与者，其中少数 f < (n/3) 可以被破坏（拜占庭错误）。

通过抽象，在该模型中，诚实方之间的通信是异步且可靠的。消息可以在任何延迟下传输，完成的部分最终可能会丢失。

借助键值系统，独角鲸内存矿池允许所有网络参与者访问所有交易块的抽象。维护内存矿池的节点可以访问存储在交易块中的值。然后，他们向同行证明这些值的可用性。

Narwhal 内存矿池基于有向无环图 (DAG)，由连续轮次构建。在详细介绍之前，让我们探索构成此 DAG 节点的交易块的正式结构。



交易块 (b) 包含以下信息：

- 一是交易列表和对之前区块的引用列表；
- 然后，其内容的唯一加密货币摘要（digest），d，用作引用该块的标识符；
- 最后是引用，编码块之间的因果关系（用 b → b’ 表示）。

因此，块内事务和引用的调度使得明确编码它们的顺序成为可能。实际上，一个块中引用的所有块都在该块的所有事务之前产生。

### 2.5 操作

以下是验证器节点可以执行的不同操作：

- 写：写（d，b）。存储包含标题（摘要）的块 b d。在输出时，将颁发唯一的 c(d) 可用性证书。它证明了写操作的成功。
- 验证：有效（d，c（d））。如果证书有效，则此操作返回“true”，否则返回 false。
- 阅读：阅读（d）。如果 write(d,b) 操作成功，read(d) 返回块 b。
- 阅读因果故事： read_causal(d)：返回包含与 b 具有因果关系的所有块的块 B 的集合。

该模型必须满足一组属性才能实现其目标。



### 2.6 所需属性

- 完整性：对于任何 d，诚实方的两次 read(d) 操作必须返回相同的值。
- 块可用性：在诚实方成功执行 write(d,b) 操作后，read(d) 操作应返回 b。
- 限制：设 B 为 read_causal(d) 返回的集合。那么对于任何属于 B 的 b’，read_causal(d’) 返回的集合 B’ 必须包含在 B 中。
- ⅔ 的因果关系：成功的 read_causal(d) 操作必须返回一个集合 B，该集合 B 包含在调用 write(d,b) 操作之前写入的至少三分之二的块。
- 半链质量：由成功的 read_causal(d) 操作产生的集合 B 中至少有一半的块是由诚实方编写的。

满足所有这些属性后，Narwhal 还必须是水平可扩展的。协议吞吐量应该随着每个验证者分配的资源而增加，而不会对延迟产生太大的负面影响。

区块的完整性和可用性的特性使得数据的传播与共识分离成为可能。因此，共识层仅用于调度块摘要的证书，大小非常小。

因果关系和包含属性确保共识层即使在异步事件中也能保持其吞吐量。事实上，一旦网络再次同步，并且区块摘要得到验证，验证者将能够完全调度在异步期间创建的所有区块（它们自己是因果调度的）。

因此，可以对 Narwhal 使用不同的拜占庭共识协议。它们的性质和网络条件会影响系统的延迟。

最后一个属性（半链的质量）确保了对审查的抵抗力。



### 2.7 Narwhal独角鲸的工作原理

对于传统的区块链，交易的传播是通过聊天协议（八卦协议）来确保的。提交给验证节点的每笔交易都会逐步传输给所有其他交易。因此存在双重传输：大多数交易通过内存矿池共享，然后矿工或验证者从中提取以创建一个块并依次共享。

Narwhal 旨在减少领导者提出区块时对双重传输的需求，并在有额外资源可用时确保模型的可扩展性。

#### 交易完整性

块，而不是交易，由客户端软件提供服务。领导者提出一个块的哈希，依靠内存矿池来证明它的完整性。

验证者必须验证哈希是否代表可用块。因此，他们必须在验证区块之前下载它们。

#### 块的可用性

区块的证书证明它是可用的（因此可以下载）。每个内存矿池块都有一个证书。

#### 交易的原因

利用因果关系，我们可以为内存矿池的多个区块颁发一个证书。实际上，内存矿池的区块包括来自所有验证者的内存矿池先前区块的证书。因此，证书指的是一个块及其完整的因果历史。

它们的大小是固定的，占用的带宽最少。然而，有两个问题。一个速度极快的验证者会通过过快地生成块来迫使其对等方使其带宽饱和。此外，诚实的验证者可能缺乏与他人共享区块的带宽。

#### 链条质量

通过对块创建率施加限制来确保这一点。

每个验证者都会为其区块分配一个整数。他还必须加入上一轮的法定人数证书，才能使区块有效。

因此，每个提案中总会包含来自诚实验证者的区块。为了进入新一轮的内存矿池，验证者必须等待其他诚实的验证者完成前几轮。

除了防止泛滥之外，这种机制还确保了协议的抗审查性。事实上，每个区块，即使是由恶意领导者发布，也总是包含至少 50% 的诚实交易。因此，如果对手不喜欢提议的区块，他就不能“杀死”领导者。

#### 可扩展性

为确保此属性，验证器将块分成子块（称为批次），具体取决于专用于创建内存矿池块任务的机器数量。“主”块集成了对内存矿池中子块的引用。

这允许验证者有效地分配计算、存储和网络资源以共享这些交易集。可扩展性几乎是线性的。

由于这些不同的支柱，Narwhal 可以超越简单的内存矿池：它是一个强大且高性能的数据可用性和分布层。



![image-20230413163750807](https://picture-1258612855.cos.ap-shanghai.myqcloud.com/202304131637837.png)

- POS共识：同一时间，只有一个验证人节点打包区块。
- Narwhal 异步共识：同一时间，所有验证人都在生产区块。
  - 收到2/3+1的证书后，即可产生一块



### 2.8 Tusk 一种异步共识机制

Tusk 是 Narwhal 附带的异步共识机制，以实现最佳性能。受 DAG-Rider 的启发，Tusk 是一种现代实现，可以显着改善其延迟。

Tusk 的验证器使用 Narwhal 作为数据可用性层——内存矿池——并在每个区块中包含一个完全随机生成的令牌（数字）。这种随机令牌可以通过阈值签名方案生成，并且即使在异步情况下也可以设置方案参数。

Tusk 的算法，得益于 Narwhal 的因果调度 DAG，允许完全调度块，而不需要额外的通信。每个验证者在本地解释其 DAG，并使用随机令牌来定义块的最终排序。

### 过程

该过程分为连续3轮round为一个wave。

![image-20230413173014008](https://picture-1258612855.cos.ap-shanghai.myqcloud.com/202304131730046.png)

图斯克提交规则——对于每一轮竞标，随机选择轮次 r – 2 的领导者。如果领导者的票数少于 f+1（红色），则跳过。否则，该算法搜索 DAG（和相应的因果历史）以参与所有先前的领导者（包括红色）。然后它完全确定DAG 的其余部分。

1. 每个验证者都会提出其区块及其因果历史。
2. 每个验证者都对提案进行投票，包括在他们的自己的区块。
3. 验证者随机选出一个领导者。

当随机波令牌显示时：

- 如果第二轮 w（v 的 DAG 的本地视图）有 af + 1 个投票，则每个验证者 v 提交波 w 的选出的领导者块 b。
- 如果是这样，验证器 v 将 b 的因果历史排序到垃圾收集点。![image-20230413174208740](https://picture-1258612855.cos.ap-shanghai.myqcloud.com/202304131742804.png)



### 2.9 Bullshark

![image-20230413180909718](https://picture-1258612855.cos.ap-shanghai.myqcloud.com/202304131809763.png)





# sui代码解读

## sui节点架构

![image-20230413181518990](https://picture-1258612855.cos.ap-shanghai.myqcloud.com/202304131815035.png)