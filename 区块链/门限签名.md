# 门限签名

门限签名（Threshold Signature Scheme，TSS）是数字签名的一个重要分支，它是一种基于安全多方计算（Secure Multi-Party Computation，MPC）的密码学技术，也是 MPC 密钥管理的重要研究方向。

1. 没有任何人知道完整的私钥，也即私钥永远不会出现。
2. 所有参与者共同计算出完整私钥所对应的公钥。
3. 需要m个参与者(m≤n)即可产生对应完整私钥的签名。

![image-20230412110830330](https://picture-1258612855.cos.ap-shanghai.myqcloud.com/202304121108354.png)

## 1. 门限密钥生成

先设想一下如何分布式地保存私钥。私钥本质上是自然数，假设我的私钥是50，我可以拆分成10+25+15三个私钥片段分别给三个不同的人保管。上述方案对TSS而言有三个问题：

- 三个人必须同时出现，少一方都无法恢复这个私钥，有严重的单点故障，不符合门限的需求。
- 『我』是一个中心化的实体，不符合dealerless的要求。
- 完整的私钥在分发和重构时出现了两次。不符合完整的私钥永不出现这一性质。

所以，如果要实现一个2-of-3（三人持私钥片段，任意两人即可签名）的门限密钥生成方案，先让三人`Pᵢ (i∈[1,3])`每个人各自生成自己的私钥片段`uᵢ`并秘密地保存起来。由于门限要求，那么这三人所持有的私钥片段之间必须有**间接的数学联系**，以在缺少一方的情况下也有恢复完整私钥的能力。

注意，这里所说的具有**『恢复完整私钥的能力』只是一种『能力』**，并非要实施『恢复完整私钥』这个行为。该能力实际上等价于『可用签名碎片拼出对应完整私钥的签名的能力』，后者对应的行为才是我们最终要实施的。所以在下文中提到『恢复完整的私钥』时，仅仅指的是这种能力，或者在思维实验中实施该行为，而非要在现实的TSS方案中进行。



## 2. SSS与『间接的数学联系』

假设私钥碎片为`u₁=20, u₂=40, u₃=80`。如果允许中心化的dealer和完整的私钥出现，那每个人把私钥`uᵢ`发给dealer，他就可以计算出完整私钥`u=140`后用**Shamir秘密共享**（SSS）方案：把完整私钥拆碎后再分配，在拆分和合成过程中这些私钥碎片之间会用**拉格朗日多项式**产生间接的数学联系。

### 2.1 SSS的秘密分发

现有门限参数m-of-n，dealer对秘密`u`进行SSS：

1. 先构造最高次为`t = m - 1`的**主多项式**`F(x)`

![202304121058134](https://picture-1258612855.cos.ap-shanghai.myqcloud.com/202304121058894.png)

其中多项式系数`a₁...aₜ`都是dealer随机选择的

常量`u`就是要共享的秘密，有`F(0) = u`

Dealer把`F(i)`分享给`Pᵢ`(`i∈[1,n]`)，`Pᵢ`记录下坐标点`(i,F(i))`。Dealer销毁主多项式。分享结束。注意，除了dealer每个人只知道自己的值`F(i)`，但并不知道主多项式`F(x)`的具体式子。

具体到我们的例子中，即
`F(x) = 140 + 5x`, `P₁得到F(1)=145`, `P₂得到F(2)=150`, `P₃得到F(3)=155`.

### 2.2 SSS的秘密重构

1. 确定参与重构的人数不得少于`m`，记∀重构者编号`i`的集合为`Φ`
2. 每个参与者`Pᵢ`公布自己的坐标点`(i,F(i))`
3. 计算每个人的拉格朗日基函数`lᵢ(x)`并得到拉格朗日插值多项式`L(x)`

 ![image-20230412110837617](https://picture-1258612855.cos.ap-shanghai.myqcloud.com/202304121108647.png)

4. 展开`L(x)`后其常数项就是秘密

具体到我们的例子中，秘密被分片到了三个人手中，但只需要两个人即可重构。比如，P₁和P₂进行重构，我们得到两个坐标点`(1,145)和(2,150)`，使用拉格朗日插值法得：

![image-20230412110823672](https://picture-1258612855.cos.ap-shanghai.myqcloud.com/202304121108696.png)

可以看到常数项`140`已经展现了出来，也即我们要恢复的秘密。

拉格朗日插值法本质是对若干个随意的数据点拟合出一条合适的多项式曲线。纵观上述过程，我们先巧妙地构造了一个`x=0`时值为`秘密`的多项式，然后利用`m个点可以唯一确定一个最高为m-1次的多项式`的性质，将秘密沿着多项式分发给每个参与者。我们选用的是2-of-3作为讲解，也即`m=2,n=3`，所以例子中的多项式是一个非常简单的一次函数。我们可以在这个函数上任意增加点，也即秘密共享者，而只需要两个点就可以重构出整个一次函数并取得秘密，少于两个则不行，也即实现了门限的需求。

<img src="https://picture-1258612855.cos.ap-shanghai.myqcloud.com/202304121110433.png" alt="image-20230412111001402" style="zoom:50%;" />

上述过程即SSS的核心原理。实际的SSS为了安全性还使用了素数的模运算和费马小定理等，这里按下不表。

## 3. 去除Dealer

虽然上述过程看起来很有意思，不过别忘了它是有中心化Dealer参与的，私钥也现身了两次，不符合我们的需求。
 但我们可以通过每个人都对`自己+其余人`进行SSS的方式，分享出自己的秘密`uᵢ`，在不出现`u`的情况下拆分成新的秘密碎片`χᵢ`，从而满足我们的需求。

以`P₁`为例，他自己当delaer，在`P₁`， `P₂`，`P₃`间进行2-of-3共享。这里和上面不太一样的是，dealer自己也是被共享者。

由于`u₁=20`，则
`F₁(x) = 20 + 2x`, `P₁得到F₁(1)=22`, `P₂得到F₁(2)=24`, `P₃得到F₁(3)=26`.

由于`u₂=40`，则
`F₂(x) = 40 + 6x`, `P₁得到F₂(1)=46`, `P₂得到F₂(2)=52`, `P₃得到F₂(3)=58`.

由于`u₃=80`，则
`F₃(x) = 80 + 10x`, `P₁得到F₃(1)=90`, `P₂得到F₃(2)=100`, `P₃得到F₃(3)=110`.

`∀Pᵢ`分别计算自己新生成的秘密碎片`χᵢ`并私密保存：
 `χ₁=F₁(1)+F₂(1)+F₃(1)=158`,
 `χ₂=F₁(2)+F₂(2)+F₃(2)=176`,
 `χ₃=F₁(3)+F₂(3)+F₃(3)=194`.

验证一下：用拉格朗日插值法可得出`L(x)=18x+140`，我们的完整私钥`u=140`依然成立。当然，再次提醒，这个验证步骤我们实际是不可能进行的，私钥`u`和`L(x)`永远不会有人知道。

在实操中，GG20并不使用SSS，而是使用其升级版Feldman VSS，在不暴露多项式的情况下确定每个人的多项式运算不存在作弊行为。这里不进行详解。



## 4. 公钥计算

上面我们已经成功将碎片`uᵢ`重新划分为新的私钥碎片`χᵢ`。后续为了方便书写我们将用`x`表示私钥及其分片`xᵢ`，用`y`表示公钥。

由于GG20中使用的G-DSA支持DSA（离散对数数字签名方案）和ECDSA（椭圆曲线数字签名方案），可以生成这两种方案的公钥：

```
y_DSA = gˣ
y_ECDSA = xG
```

g和G分别为循环群和椭圆曲线的生成元，我们这里不需要理解这个具体是什么概念，只需要知道不可能用`gˣ`或`xG`的值来反推出`x`即可。

因为我们不能直接计算`x=∑xᵢ`（不成立）或者`u=∑uᵢ`（禁止暴露），所以只需`∀Pᵢ`计算自己的`g^(uᵢ)`或`uᵢG`并公布然后进行拼接，最后得到公钥：

![image-20230412113457548](https://picture-1258612855.cos.ap-shanghai.myqcloud.com/202304121134582.png)

## 5. 门限签名

看下GG20中的G-DSA是如何定义签名和验证过程的。