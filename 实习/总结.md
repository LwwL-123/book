# bilibili实习总结

## 1.为什么要有网关？

​    试想客户端需要按业务请求不同接口方，开发规范的不同，对接部门的不同，都增加了客户端的复杂性

​    主站网关以切入 Go 应用的 API 管理为主，核心目的是：

- 统一入口：为全部服务提供一个唯一的入口，在这里可监控接口QPS、入参出参、链路时间等，保障了后台服务的安全性。
- 统一鉴权：对于鉴权操作不涉及到业务逻辑，全由网关层处理，下层service信任即可（如playurl、秒开、投币、点赞）
- 唯一出口：入参出参规则统一，接入方便，风险降低
- 流量控制与熔断降级：网关层接入流量控制中间件，实现对下层业务的保护，同时使用降级中间件、二级缓存等，对重要业务进行降级、避免客户端崩溃或空窗

## 2.网关、流量网关、业务网关

### 2.1 网关（Gateway）

在传输层上以实现网络互连，它主要负责统一接入，然后将请求的协议转换成内部的接口协议。

### 2.2 API网关

  a.所有API的调用统一接入API网关层，由网关层负责接入和输出。

  b.分类：  

- 流量网关：和具体的后端业务完全无关的部分，比如安全策略、流量分发策略等

- 业务网关：针对具体的后端业务系统，或者是服务和业务有关系的部分，一般被直接部署在业务服务的前面

  ![image-20220507125845654](https://picture-1258612855.cos.ap-shanghai.myqcloud.com/20220507125845.png)

### 2.3 B站业务网关

​    主要功能：对外提供接口供客户端调用，主要通过http/rpc接口去调取各个业务数据，然后聚合返回给客户端

![image-20220507125953374](https://picture-1258612855.cos.ap-shanghai.myqcloud.com/20220507125953.png)

-  http类型的接口上层对接slb，grpc类型的接口上层对接moss
- 客户端请求moss接口使用[grpc.biliapi.net](http://grpc.biliapi.net/)域名请求，当因为链路等原因失败时，会通过gRPC-web协议，使用[app.bilibili.com](http://app.bilibili.com/)域名再次请求，此时依旧访问的是moss服务，当第一次请求出问题时，重试的请求往往也是有问题的。[peat-moss](http://caster.bilibili.co/prod/app/6419) 设计为线上 moss envoy 的异构代理服务，当请求moss失败时，通过修改slb配置，将请求转发到peat-moss服务中，避免moss服务问题导致重试依旧失败。目前已经有一些应用接入了peat-moss。



## 需求

1. 繁体版历史记录正常展示直播内容
2. 【IPAD网关】请求清晰度更改 （学习：灰度测试，一致性哈希算法：crc32的crc32.ChecksumIEEE）
3. 搜索彩蛋接入统一错峰sdk（学习：api的设计）