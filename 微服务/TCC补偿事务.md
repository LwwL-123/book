# TCC(补偿事务)

## 1、TCC事务

TCC的核心思想是：针对每一个操作都需要注册一个和其相对应的确认和补偿的操作，他分为三个阶段Try、Confirm和Cancel

- **Try 阶段**主要是对业务系统做检测及资源预留
- **Confirm 阶段**主要是对业务系统做确认提交，Try阶段执行成功并开始执行Confirm阶段时，默认Confirm阶段是不会出错的。即：只要Try成功，Confirm一定成功。若Confirm阶段真的出错了，需引入重试机制或人工处理。
- **Cancel阶段**主要是在业务执行错误，需要回滚的状态下执行的业务取消，预留资源释放。

![在这里插入图片描述](https://picture-1258612855.cos.ap-shanghai.myqcloud.com/20220622134017.png)

- 我们利用事务里最常见的案例来向大家解释：

> A转账30元给B，A账户和B账户在不同银行(服务)，当前余额都为100元

![在这里插入图片描述](https://picture-1258612855.cos.ap-shanghai.myqcloud.com/20220622134023.png)

使用TTC事务，我们需要把之前实现的转账的代码拆分成三块，套到try-confirm-cancel中，由事务管理器(协调管理)推进AB两个try分别执行，在这个过程中，事务管理器会对AB进行监控，一旦任何一方出现了问题，就推进对方执行cancel；如果双方都没有异常，就推进AB执行confirm。如果在执行confirm或cancel过程中出现问题，就引入重试机制或由人工处理。

由此可见TCC解决分布式事务的缺点非常的明显：1、代码侵入性很强，改造成本很高；2、实现难度也不小，回滚策略实现并不简单。



即：

- 针对每个操作，都要注册一个与其对应的补偿（撤销）操作
- 在执行失败时，调用补偿操作，撤销之前的操作

优点：逻辑清晰、流程简单

缺点：数据一致性比CA还要差，可能出错的点比较多；TCC属于应用层的一种补偿方式，需要写大量代码