# 负载均衡

>  相关面试题 ：
>
> ●服务端负载均衡一般怎么做？
> ●四层负载均衡和七层负载均衡的区别？
> ●负载均衡的常见算法有哪些？
> ●七层负载均衡常见解决方案有哪些？
> ●客户端负载均衡的常见解决方案有哪些？



## 负载均衡介绍

指的是将用户请求分摊到不同的服务器上处理，以提高系统整体的并发处理能力。是一种比较常用且实现简单的提高系统并发能力的手段，不论是单体架构的系统还是微服务架构的系统几乎都会用到。



负载均衡分类

负载均衡可以简单分为 服务端负载均衡 和 客户端负载均衡 这两种。



## 1. 服务端负载均衡

服务端负载均衡 主要应用在 系统外部请求 和 网关层 之间，可以使用 软件 或者 硬件 实现。

下图是我画的一个简单的基于 Nginx 的服务端负载均衡示意图：

<img src="https://picture-1258612855.cos.ap-shanghai.myqcloud.com/20220704175024.png" alt="image.png" style="zoom: 67%;" />

硬件负载均衡 通过专门的硬件设备（比如 F5、A10、Array ）实现负载均衡功能。

硬件负载均衡的优势是性能很强且稳定，缺点就是实在是太贵了。像基础款的 F5 最低也要 20 多万，绝大部分公司是根本负担不起的，业务量不大的话，真没必要非要去弄个硬件来做负载均衡，用软件负载均衡就足够了！

在我们日常开发中，一般很难接触到硬件负载均衡，接触的比较多的还是 软件负载均衡 。软件负载均衡通过软件（比如 LVS、Nginx、HAproxy ）实现负载均衡功能，性能虽然差一些，但价格便宜啊！像基础款的 Linux 服务器也就几千，性能好一点的 2~3 万的就很不错了。

根据 OSI 模型，服务端负载均衡还可以分为：

●二层负载均衡
●三层负载均衡
●四层负载均衡
●七层负载均衡

最常见的是四层和七层负载均衡，因此，本文也是重点介绍这两种负载均衡。

![image-20220629162929173](https://picture-1258612855.cos.ap-shanghai.myqcloud.com/20220704175032.png)

- 四层负载均衡 工作在 OSI 模型第四层，也就是传输层，这一层的主要协议是 TCP/UDP，负载均衡器在这一层能够看到数据包里的源端口地址以及目的端口地址，会基于这些信息通过一定的负载均衡算法将数据包转发到后端真实服务器。

- 七层负载均衡 工作在 OSI 模型第七层，也就是应用层，这一层的主要协议是 HTTP 。这一层的负载均衡比四层负载均衡路由网络请求的方式更加复杂，它会读取报文的数据部分（比如说我们的 HTTP 部分的报文），然后根据读取到的数据内容（如 URL、Cookie）做出负载均衡决策。

七层负载均衡比四层负载均衡会消耗更多的性能，不过，也相对更加灵活，能够更加智能地路由网络请求，比如说你可以根据请求的内容进行优化如缓存、压缩、加密。

简单来说，四层负载均衡性能更强，七层负载均衡功能更强！

在工作中，我们通常会使用 Nginx 来做七层负载均衡，LVS(Linux Virtual Server 虚拟服务器， Linux 内核的 4 层负载均衡)来做四层负载均衡。



## 2. 客户端负载均衡

客户端负载均衡 主要应用于系统内部的不同的服务之间，可以使用现成的负载均衡组件来实现。

在客户端负载均衡中，客户端会自己维护一份服务器的地址列表，发送请求之前，客户端会根据对应的负载均衡算法来选择具体某一台服务器处理请求。



## 3. 负载均衡常见算法 

### 3.1 随机法 

随机法 是最简单粗暴的负载均衡算法。

如果没有配置权重的话，所有的服务器被访问到的概率都是相同的。如果配置权重的话，权重越高的服务器被访问的概率就越大。

未加权重的随机算法适合于服务器性能相近的集群，其中每个服务器承载相同的负载。加权随机算法适合于服务器性能不等的集群，权重的存在可以使请求分配更加合理化。

不过，随机算法有一个比较明显的缺陷：部分机器在一段时间之内无法被随机到，毕竟是概率算法，就算是大家权重一样， 也可能会出现这种情况。

### 3.2 轮询法

轮询法是挨个轮询服务器处理，也可以设置权重。

如果没有配置权重的话，每个请求按时间顺序逐一分配到不同的服务器处理。如果配置权重的话，权重越高的服务器被访问的次数就越多。

未加权重的轮询算法适合于服务器性能相近的集群，其中每个服务器承载相同的负载。加权轮询算法适合于服务器性能不等的集群，权重的存在可以使请求分配更加合理化

### 3.3 一致性 Hash 法

相同参数的请求总是发到同一台服务器处理，比如同个 IP 的请求。

### 3.4 最小连接法

当有新的请求出现时，遍历服务器节点列表并选取其中活动连接数最小的一台服务器来响应当前请求。活动连接数可以理解为当前正在处理的请求数。

最小连接法可以尽可能最大地使请求分配更加合理化，提高服务器的利用率。不过，这种方法实现起来也最复杂，需要监控每一台服务器处理的请求连接数。



## 4. 七层负载均衡常见方案

### 4.1 DNS 解析

DNS 解析是比较早期的七层负载均衡实现方式，非常简单。

DNS 解析实现负载均衡的原理是这样的：在 DNS 服务器中为同一个主机记录配置多个 IP 地址，这些 IP 地址对应不同的服务器。当用户请求域名的时候，DNS 服务器采用轮询算法返回 IP 地址，这样就实现了轮询版负载均衡。

![img](https://picture-1258612855.cos.ap-shanghai.myqcloud.com/20220704175043.png)

现在的 DNS 解析几乎都支持 IP 地址的权重配置，这样的话，在服务器性能不等的集群中请求分配会更加合理化。像我自己目前正在用的阿里云 DNS 就支持权重配置。

### 4.2 反向代理

客户端将请求发送到反向代理服务器，由反向代理服务器去选择目标服务器，获取数据后再返回给客户端。对外暴露的是反向代理服务器地址，隐藏了真实服务器 IP 地址。反向代理“代理”的是目标服务器，这一个过程对于客户端而言是透明的。

Nginx 就是最常用的反向代理服务器，它可以将接收到的客户端请求以一定的规则（负载均衡策略）均匀地分配到这个服务器集群中所有的服务器上。

反向代理负载均衡同样属于七层负载均衡。

<img src="https://picture-1258612855.cos.ap-shanghai.myqcloud.com/20220704175050.png" alt="img" style="zoom: 33%;" />









更新的缓存包括：用户点赞列表、稿件被点赞列表、稿件被点赞计数表；

| 点赞流程                | 说明                                                         |
| :---------------------- | :----------------------------------------------------------- |
| 步骤1：管控状态校验     |                                                              |
| 步骤2：点赞类型校验     | 点赞对象的类型校验，目前支持22种类型                         |
| 步骤3：点赞状态校验     | 从db查点赞的状态，与用户的点赞行为做校验，确定是点赞、取消点赞、重复点赞、点赞反转(之前是点踩状态)；如果是重复点赞，需要发送消息给job； |
| 步骤4：发送消息给job    | 发送点赞的消息                                               |
| 步骤5：job校验msg消息   | 点赞对象的类型校验                                           |
| 步骤6：写入db           | 校验点赞状态，参考步骤3；更新db的点赞状态；                  |
| 步骤7：聚合稿件的点赞数 | 为了防止热门稿件对db造成写压力过大，对稿件的计数聚合后再写入db； |
| 步骤8：更新缓存         | 稿件状态；用户点赞列表；稿件点赞人列表；                     |
| 步骤9：发送点赞消息     | 用于前端更新稿件的点赞数                                     |
| 步骤10：拜年祭相关      | 增加主稿件的点赞数，修改对应的缓存等；                       |