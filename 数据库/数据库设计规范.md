# 数据库规范

## 一、数据库设计规范

#### 1.1 必须遵守

- 库名、表名、字段名、索引名必须使用小写字母，并且不能以MySQL关键字&保留字命名；[MySQL 5.7 关键字&保留字](https://dev.mysql.com/doc/refman/5.7/en/keywords.html)
- 所有的数据库、表除特殊情况外(表情支持等)，都不需要手动指定字符集

```sql
CREATE TABLE `cloud_bill_analyze_record` (
`id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '自增主键ID',
`cloud_id` varchar(32) NOT NULL DEFAULT '' COMMENT '云平台id',
`cloud_account` int NOT NULL DEFAULT 0 COMMENT '云平台云账户',
`cloud_account_name` varchar(64) NOT NULL DEFAULT '' COMMENT '云平台云账户名',
`collection_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '采集时间',
`ctime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
`mtime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
PRIMARY KEY (`id`),
KEY `ix_mtime` (`mtime`)
) ENGINE=InnoDB COMMENT='云账单分析记录';
```

- 所有表必须有INT/BIGINT unsigned NOT NULL AUTO_INCREMENT类型的主键，提高顺序insert效率，强烈建议该列与业务没有联系，并且不建议使用组合主键，仅仅作为自增主键id使用；

> INT／BIGINT如何选择？
>
> 当表的预估数据量在42亿条以内，请使用INT UNSIGNED；
>
> 当表的预估数据量超过42亿条，请使用BIGINT UNSIGNED;
>
> 数据增删比较频繁或者不确定行数的表，请使用BIGINT UNSIGNED;
>
> DBA后续将提供全全局唯一ID服务，用来代替现有的自增实现方案，其初始值将超过int的上限，建议使用bigint作为物理主键；同时全局唯一ID也是未来双写方案的必要条件。
>
> 
>
> 为什么选择自增id作为主键？
>
> http://imysql.com/2014/09/14/mysql-faq-why-innodb-table-using-autoinc-int-as-pk.shtml
>
> a. 主键自增，数据行写入可以提高插入性能，可以避免page分裂，因此降低了表碎片率，提高了磁盘空间利用率。
>
> b. 自增型主键设计(int,bigint)可以降低二级索引的空间，提升二级索引的内存命中率；
>
> c. 主键要选择较短的数据类型， Innodb引擎普通索引都会保存主键的值，较短的数据类型可以有效的减少索引的磁盘空间，提高索引的缓存效率;
>
> d. 无主键的表删除，在row模式的主从架构，会导致备库夯住。

- 所有字段都是必须用NOT NULL DEFAULT 属性，避免字段存在NULL值，不便于计算与比较；

> 数值类型使用：NOT NULL DEFAULT 0
>
> 字符类型使用：NOT NULL DEFAULT ""
>
> 特别注意：timestamp类型不指定默认值的话，MariaDB 会默认给0；多于一个timestamp字段没有指定默认值，会自动给一个timestamp默认值为 CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP，其他为0。
>
> 为什么要使用NOT NULL属性？
>
> a. NULL的列使索引/索引统计/值比较都更加复杂，对MySQL来说更难优化；
>
> b. NULL这种类型MySQL内部需要进行特殊处理，增加数据库处理记录的复杂性；同等条件下，表中有较多空字段的时候，数据库的处理性能会降低很多；
>
> c. NULL值需要更多的存储空，无论是表还是索引中每行中的null的列都需要额外的空间来标识；
>
> d. 对NULL 的处理时候，只能采用is null或is not null，而不能采用=、in、<、<>、!=、not in这些操作符号。如：where name!=’bilibili’，如果存在name为null值的记录，查询结果就不会包含name为null值的记录。
>
> e. 表关联或者where字段判断时，有NULL值会导致返回结果跟实际结果不一致。

- 所有表必须携带ctime(创建时间),mtime(最后修改时间)这两个字段，便于数据分析以及故障排查；

```
#两个字段的类型如下，只需要在建表时建立即可，不需要开发人员再往其中插入时间值，前提是INSERT INTO语句显示的字段名称：ctime DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间'mtime DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后修改时间'
```

- 所有表以及字段必须添加COMMENT，方便自己和他人阅读，一段时间之后可能连自己都不知道这些没有加COMMENT的字段是干嘛的(这是真实存在的事件)；
- 非唯一索引按照”ix*字段名称[*字段名称]”进行命名，如ix_uid_name;
- 唯一索引按照”uk*字段名称[*字段名称]”进行命名，如uk_uid_name;

> INT: 存储范围：-2147483648 to 2147483647 对应的时间范围: 1970/1/1 8:00:00 – 2038/1/19 11:14:07
>
> INT UNSIGNED: 存储范围：0 to 4294967295 对应的时间范围：1970/1/1 8:00:00 – 2106/2/7 14:28:15

- 所有表必须将mtime增加一个普通索引ix_mtime(mtime)，便于数据平台、AI、搜索部门增量获取数据。
- 单实例单业务，不要混合业务使用数据库

